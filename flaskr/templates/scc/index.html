{% extends 'base.html' %}
{% block content %}
{% set condition_names = {
    'default': 'Default',
    '404error': '404 Error',
    '500error': '500 Error',
    '502error': '502 Error',
    '503error': '503 Error',
    '429ratelimit': '429 Rate Limit',
    'validationerror': 'Validation Error',
    'contenterror': 'Content Error',
    'missingcss': 'Missing CSS',
    'missingjs': 'Missing JS',
    'largeimage': 'Large Image',
    'heroimage': 'Hero Image',
    'contentdelay': 'Content Delay',
    'slowttfb': 'Slow TTFB',
    'timeout': 'Timeout',
    'redirectloop': 'Redirect Loop',
    'maintenance': 'Maintenance',
    'brokenlinks': 'Broken Links',
    'cookies': 'Cookies',
    'security-jsinjected': 'Security - JS Injected',
    'security-eskimmer': 'Security - eskimmer',
    'security-deface': 'Security - Deface',
    'security-crypto': 'Security - Crypto'
} %}
<!-- Toast Notifications -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="fixed top-4 right-4 z-[9999] space-y-2">
    {% for category, message in messages %}
    <div x-data="{ show: true }"
         x-show="show"
         x-init="setTimeout(() => show = false, 5000)"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-x-8"
         x-transition:enter-end="opacity-100 translate-x-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-x-0"
         x-transition:leave-end="opacity-0 translate-x-8"
         class="flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg min-w-[320px] {% if category == 'error' %}bg-red-50 border border-red-200 text-red-800{% else %}bg-green-50 border border-green-200 text-green-800{% endif %}">
        <span class="material-symbols-outlined icon-sm {% if category == 'error' %}text-red-500{% else %}text-green-500{% endif %}">{% if category == 'error' %}error{% else %}check_circle{% endif %}</span>
        <span class="flex-1 text-sm font-medium">{{ message }}</span>
        <button @click="show = false" class="p-1 hover:bg-black/5 rounded transition-colors">
            <span class="material-symbols-outlined icon-xs opacity-50">close</span>
        </button>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<div x-data="{ endpointsDropdown: false, obsDropdown: false, splunkDropdown: false, userDropdown: false }"
     class="min-h-screen bg-splunk-gray-50">

    <!-- Main Content -->
    <div class="flex flex-col min-h-screen">
        <!-- Top Navigation -->
        <header class="h-14 bg-splunk-gray-800 flex items-center justify-between px-4 lg:px-6 sticky top-0 z-10">
            <!-- Left: Logo + Title -->
            <div class="flex items-center gap-4">
                <a href="/" class="flex items-center gap-3">
                    <img src="{{ url_for('static', filename='img/splunk-logo-white.png') }}" class="h-5" alt="Splunk">
                </a>
                <div class="hidden sm:block w-px h-5 bg-splunk-gray-600"></div>
                <h1 class="hidden sm:block text-sm font-semibold text-white">SynCreator</h1>
            </div>

            <!-- Right: Actions -->
            <div class="flex items-center gap-1">
                <!-- Endpoints Dropdown -->
                <div class="relative">
                    <button @click="endpointsDropdown = !endpointsDropdown; obsDropdown = false; splunkDropdown = false; userDropdown = false"
                            class="flex items-center gap-2 px-3 py-2 text-sm text-splunk-gray-300 hover:bg-splunk-gray-700 rounded-lg transition-colors">
                        <span class="material-symbols-outlined icon-sm text-splunk-light">link</span>
                        <span class="hidden md:inline">Endpoints</span>
                    </button>
                    <div x-show="endpointsDropdown"
                         @click.outside="endpointsDropdown = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-lg border border-splunk-gray-200 overflow-hidden z-50">
                        <div class="px-4 py-3 bg-splunk-gray-50 border-b border-splunk-gray-200">
                            <h3 class="font-semibold text-splunk-gray-800">Test Endpoints</h3>
                            <p class="text-xs text-splunk-gray-500">URLs for synthetic testing</p>
                        </div>
                        <div class="py-1">
                            <a href="{{ request.url }}view/{{ g.user['username'] }}" target="_blank"
                               class="flex items-center gap-3 px-4 py-2.5 text-sm text-splunk-gray-700 hover:bg-splunk-gray-50 transition-colors">
                                <span class="material-symbols-outlined icon-sm text-splunk-gray-400">public</span>
                                Real Browser Test
                                <span class="material-symbols-outlined icon-xs text-splunk-gray-300 ml-auto">open_in_new</span>
                            </a>
                            <a href="{{ request.url }}api/v1/{{ g.user['username'] }}/books/all" target="_blank"
                               class="flex items-center gap-3 px-4 py-2.5 text-sm text-splunk-gray-700 hover:bg-splunk-gray-50 transition-colors">
                                <span class="material-symbols-outlined icon-sm text-splunk-gray-400">code</span>
                                API - All Books
                                <span class="material-symbols-outlined icon-xs text-splunk-gray-300 ml-auto">open_in_new</span>
                            </a>
                            <a href="{{ request.url }}api/v1/{{ g.user['username'] }}/books?id=1" target="_blank"
                               class="flex items-center gap-3 px-4 py-2.5 text-sm text-splunk-gray-700 hover:bg-splunk-gray-50 transition-colors">
                                <span class="material-symbols-outlined icon-sm text-splunk-gray-400">code</span>
                                API - By ID
                                <span class="material-symbols-outlined icon-xs text-splunk-gray-300 ml-auto">open_in_new</span>
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Observability Cloud -->
                <div class="relative">
                    <button @click="obsDropdown = !obsDropdown; endpointsDropdown = false; splunkDropdown = false; userDropdown = false"
                            class="flex items-center gap-2 px-3 py-2 text-sm text-splunk-gray-300 hover:bg-splunk-gray-700 rounded-lg transition-colors">
                        <span class="material-symbols-outlined icon-sm text-splunk-light">cloud</span>
                        <span class="hidden md:inline">O11y Cloud</span>
                    </button>
                    <div x-show="obsDropdown"
                         @click.outside="obsDropdown = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-lg border border-splunk-gray-200 overflow-hidden z-50">
                        <div class="px-4 py-3 bg-splunk-gray-50 border-b border-splunk-gray-200">
                            <h3 class="font-semibold text-splunk-gray-800">Observability Cloud</h3>
                            <p class="text-xs text-splunk-gray-500">Configure your connection</p>
                        </div>
                        <form method="post" action="rum" class="p-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-splunk-gray-700 mb-1">Realm</label>
                                <input type="text" name="realm" placeholder="{{ g.user['realm'] or 'e.g., us1' }}"
                                       class="w-full px-3 py-2 text-sm border border-splunk-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-splunk/50 focus:border-splunk">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-splunk-gray-700 mb-1">Ingest Token</label>
                                <input type="password" name="ingesttoken"
                                       value="{{ g.user['ingest_token'] or '' }}"
                                       class="w-full px-3 py-2 text-sm border border-splunk-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-splunk/50 focus:border-splunk">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-splunk-gray-700 mb-1">RUM Token</label>
                                <input type="password" name="rumtoken"
                                       value="{{ g.user['rum_token'] or '' }}"
                                       class="w-full px-3 py-2 text-sm border border-splunk-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-splunk/50 focus:border-splunk">
                            </div>
                            <button type="submit" class="w-full py-2 bg-splunk hover:bg-splunk-dark text-white text-sm font-medium rounded-lg transition-colors">
                                Save Configuration
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Splunk Enterprise -->
                <div class="relative">
                    <button @click="splunkDropdown = !splunkDropdown; endpointsDropdown = false; obsDropdown = false; userDropdown = false"
                            class="flex items-center gap-2 px-3 py-2 text-sm text-splunk-gray-300 hover:bg-splunk-gray-700 rounded-lg transition-colors">
                        <span class="material-symbols-outlined icon-sm text-splunk-light">storage</span>
                        <span class="hidden md:inline">Splunk</span>
                    </button>
                    <div x-show="splunkDropdown"
                         @click.outside="splunkDropdown = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-lg border border-splunk-gray-200 overflow-hidden z-50">
                        <div class="px-4 py-3 bg-splunk-gray-50 border-b border-splunk-gray-200">
                            <h3 class="font-semibold text-splunk-gray-800">Splunk Enterprise</h3>
                            <p class="text-xs text-splunk-gray-500">HEC configuration</p>
                        </div>
                        <form method="post" action="splunk" class="p-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-splunk-gray-700 mb-1">HEC URL</label>
                                <input type="text" name="hec_url" placeholder="{{ g.user['hec_url'] or 'https://...' }}"
                                       class="w-full px-3 py-2 text-sm border border-splunk-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-splunk/50 focus:border-splunk">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-splunk-gray-700 mb-1">HEC Token</label>
                                <input type="password" name="hec_token"
                                       value="{{ g.user['hec_token'] or '' }}"
                                       class="w-full px-3 py-2 text-sm border border-splunk-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-splunk/50 focus:border-splunk">
                            </div>
                            <button type="submit" class="w-full py-2 bg-splunk hover:bg-splunk-dark text-white text-sm font-medium rounded-lg transition-colors">
                                Save Configuration
                            </button>
                        </form>
                    </div>
                </div>

                <div class="hidden sm:block w-px h-5 bg-splunk-gray-600 mx-2"></div>

                <!-- User menu -->
                <div class="relative">
                    <button @click="userDropdown = !userDropdown; endpointsDropdown = false; obsDropdown = false; splunkDropdown = false"
                            class="flex items-center gap-2 px-3 py-2 text-sm text-splunk-gray-300 hover:bg-splunk-gray-700 rounded-lg transition-colors">
                        <div class="w-7 h-7 rounded-full bg-splunk flex items-center justify-center text-white text-xs font-medium">
                            {{ g.user['username'][0]|upper }}
                        </div>
                        <span class="material-symbols-outlined icon-xs">expand_more</span>
                    </button>
                    <div x-show="userDropdown"
                         @click.outside="userDropdown = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-splunk-gray-200 overflow-hidden z-50">
                        <div class="px-4 py-3 border-b border-splunk-gray-200">
                            <p class="text-sm font-medium text-splunk-gray-800">{{ g.user['username'] }}</p>
                            <p class="text-xs text-splunk-gray-500">Realm: {{ g.user['realm'] or 'Not set' }}</p>
                        </div>
                        <div class="py-1">
                            <a href="{{ url_for('scc.create_browser_test') }}"
                               class="flex items-center gap-3 px-4 py-2.5 text-sm text-splunk-gray-700 hover:bg-splunk-gray-50 transition-colors">
                                <span class="material-symbols-outlined icon-sm text-splunk-gray-400">rocket_launch</span>
                                Deploy Synthetics Test
                            </a>
                            <a href="{{ url_for('auth.logout') }}"
                               class="flex items-center gap-3 px-4 py-2.5 text-sm text-splunk-gray-700 hover:bg-splunk-gray-50 transition-colors">
                                <span class="material-symbols-outlined icon-sm text-splunk-gray-400">logout</span>
                                Sign out
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="flex-1 p-4 lg:p-6">
            <!-- Current status banner -->
            <div id="current-condition" class="mb-6 p-4 bg-white rounded-xl border border-splunk-gray-200 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-lg bg-splunk/10 flex items-center justify-center">
                        <span class="material-symbols-outlined text-splunk">cell_tower</span>
                    </div>
                    <div>
                        <p class="text-sm text-splunk-gray-500">Current Active Condition</p>
                        <p id="condition-name" class="font-semibold text-splunk-gray-800">
                            {{ condition_names.get(condition[0], condition[0]) }}
                        </p>
                    </div>
                </div>
                <a href="{{ request.url }}view/{{ g.user['username'] }}" target="_blank"
                   class="hidden sm:flex items-center gap-2 px-4 py-2 text-sm font-medium text-splunk hover:bg-splunk hover:text-white border border-splunk rounded-lg transition-colors">
                    <span class="material-symbols-outlined icon-sm">open_in_new</span>
                    View Site
                </a>
            </div>

            <!-- Cards Grid -->
            <div id="condition-cards">
                {% include 'scc/_cards.html' %}
            </div>
        </main>
    </div>
</div>
{% endblock %}
