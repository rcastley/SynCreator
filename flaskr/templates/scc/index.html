{% extends 'base.html' %}
{% block content %}
{% set condition_names = {
    'default': 'Default',
    '404error': '404 Error',
    '500error': '500 Error',
    '502error': '502 Error',
    '503error': '503 Error',
    '429ratelimit': '429 Rate Limit',
    'validationerror': 'Validation Error',
    'contenterror': 'Content Error',
    'missingcss': 'Missing CSS',
    'missingjs': 'Missing JS',
    'largeimage': 'Large Image',
    'heroimage': 'Hero Image',
    'contentdelay': 'Content Delay',
    'slowttfb': 'Slow TTFB',
    'timeout': 'Timeout',
    'redirectloop': 'Redirect Loop',
    'maintenance': 'Maintenance',
    'brokenlinks': 'Broken Links',
    'cookies': 'Cookies',
    'security-jsinjected': 'Security - JS Injected',
    'security-eskimmer': 'Security - eskimmer',
    'security-deface': 'Security - Deface',
    'security-crypto': 'Security - Crypto'
} %}
<!-- Toast Notifications -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="fixed top-4 right-4 z-[9999] space-y-2">
    {% for category, message in messages %}
    <div x-data="{ show: true }"
         x-show="show"
         x-init="setTimeout(() => show = false, 5000)"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 translate-x-8"
         x-transition:enter-end="opacity-100 translate-x-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-x-0"
         x-transition:leave-end="opacity-0 translate-x-8"
         class="flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg min-w-[320px] {% if category == 'error' %}bg-red-50 border border-red-200 text-red-800{% else %}bg-green-50 border border-green-200 text-green-800{% endif %}">
        <i class="fas {% if category == 'error' %}fa-exclamation-circle text-red-500{% else %}fa-check-circle text-green-500{% endif %}"></i>
        <span class="flex-1 text-sm font-medium">{{ message }}</span>
        <button @click="show = false" class="p-1 hover:bg-black/5 rounded transition-colors">
            <i class="fas fa-times text-xs opacity-50"></i>
        </button>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<div x-data="{ sidebarOpen: false, obsDropdown: false, splunkDropdown: false, userDropdown: false }"
     class="min-h-screen bg-splunk-gray-50">

    <!-- Sidebar - Always fixed on mobile, static on desktop -->
    <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'"
           class="fixed inset-y-0 left-0 w-64 bg-splunk-gray-800 transform transition-transform duration-200 ease-in-out z-40 flex flex-col">

        <!-- Close button for mobile -->
        <button @click="sidebarOpen = false"
                class="lg:hidden absolute top-4 right-4 p-2 text-splunk-gray-400 hover:text-white hover:bg-splunk-gray-700 rounded-lg transition-colors">
            <i class="fas fa-times"></i>
        </button>

        <!-- Logo -->
        <div class="h-16 flex items-center justify-center border-b border-splunk-gray-700">
            <a href="/">
                <img src="{{ url_for('static', filename='img/splunk_logo_white.png') }}" class="h-8" alt="Splunk">
            </a>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-3 py-4 overflow-y-auto">
            <p class="px-3 text-xs font-semibold text-splunk-gray-400 uppercase tracking-wider mb-3">Test URLs</p>

            <!-- Collapsible Menu -->
            <div x-data="{ open: false }">
                <button @click="open = !open"
                        class="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-splunk-gray-300 rounded-lg hover:bg-splunk-gray-700 transition-colors">
                    <i class="fas fa-link w-5 text-center"></i>
                    <span class="flex-1 text-left">Endpoints</span>
                    <i class="fas fa-chevron-down text-xs transition-transform duration-200" :class="open && 'rotate-180'"></i>
                </button>
                <div x-show="open" x-collapse class="mt-1 ml-8 space-y-1">
                    <a href="{{ request.url }}view/{{ g.user['username'] }}" target="_blank"
                       class="flex items-center gap-2 px-3 py-2 text-sm text-splunk-gray-400 hover:text-white rounded-lg hover:bg-splunk-gray-700 transition-colors">
                        <i class="fas fa-external-link-alt text-xs"></i>
                        Real Browser
                    </a>
                    <a href="{{ request.url }}api/v1/{{ g.user['username'] }}/books/all" target="_blank"
                       class="flex items-center gap-2 px-3 py-2 text-sm text-splunk-gray-400 hover:text-white rounded-lg hover:bg-splunk-gray-700 transition-colors">
                        <i class="fas fa-external-link-alt text-xs"></i>
                        API - All Books
                    </a>
                    <a href="{{ request.url }}api/v1/{{ g.user['username'] }}/books?id=1" target="_blank"
                       class="flex items-center gap-2 px-3 py-2 text-sm text-splunk-gray-400 hover:text-white rounded-lg hover:bg-splunk-gray-700 transition-colors">
                        <i class="fas fa-external-link-alt text-xs"></i>
                        API - By ID
                    </a>
                </div>
            </div>
        </nav>

        <!-- User section at bottom -->
        <div class="p-3 border-t border-splunk-gray-700">
            <div class="flex items-center gap-3 px-3 py-2">
                <div class="w-8 h-8 rounded-full bg-splunk flex items-center justify-center text-white text-sm font-medium">
                    {{ g.user['username'][0]|upper }}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">{{ g.user['username'] }}</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Mobile overlay -->
    <div x-show="sidebarOpen"
         x-cloak
         @click="sidebarOpen = false"
         class="fixed inset-0 bg-black/50 z-30 lg:hidden"
         x-transition:enter="transition-opacity ease-out duration-200"
         x-transition:leave="transition-opacity ease-in duration-150"></div>

    <!-- Main Content - offset for sidebar on desktop -->
    <div class="lg:ml-64 flex flex-col min-h-screen">
        <!-- Top Navigation -->
        <header class="h-16 bg-white border-b border-splunk-gray-200 flex items-center justify-between px-4 lg:px-6 sticky top-0 z-10">
            <!-- Left: Mobile menu + Title -->
            <div class="flex items-center gap-4">
                <button @click="sidebarOpen = !sidebarOpen"
                        class="lg:hidden p-2 -ml-2 text-splunk-gray-500 hover:text-splunk-gray-700 hover:bg-splunk-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                <h1 class="text-lg font-semibold text-splunk-gray-800">Condition Manager</h1>
            </div>

            <!-- Right: Actions -->
            <div class="flex items-center gap-1">
                <!-- Observability Cloud -->
                <div class="relative">
                    <button @click="obsDropdown = !obsDropdown; splunkDropdown = false; userDropdown = false"
                            class="flex items-center gap-2 px-3 py-2 text-sm text-splunk-gray-600 hover:bg-splunk-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-cloud text-splunk"></i>
                        <span class="hidden md:inline">O11y Cloud</span>
                    </button>
                    <div x-show="obsDropdown"
                         @click.outside="obsDropdown = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-lg border border-splunk-gray-200 overflow-hidden z-50">
                        <div class="px-4 py-3 bg-splunk-gray-50 border-b border-splunk-gray-200">
                            <h3 class="font-semibold text-splunk-gray-800">Observability Cloud</h3>
                            <p class="text-xs text-splunk-gray-500">Configure your connection</p>
                        </div>
                        <form method="post" action="rum" class="p-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-splunk-gray-700 mb-1">Realm</label>
                                <input type="text" name="realm" placeholder="{{ g.user['realm'] or 'e.g., us1' }}"
                                       class="w-full px-3 py-2 text-sm border border-splunk-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-splunk/50 focus:border-splunk">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-splunk-gray-700 mb-1">Ingest Token</label>
                                <input type="password" name="ingesttoken"
                                       value="{{ g.user['ingest_token'] or '' }}"
                                       class="w-full px-3 py-2 text-sm border border-splunk-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-splunk/50 focus:border-splunk">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-splunk-gray-700 mb-1">RUM Token</label>
                                <input type="password" name="rumtoken"
                                       value="{{ g.user['rum_token'] or '' }}"
                                       class="w-full px-3 py-2 text-sm border border-splunk-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-splunk/50 focus:border-splunk">
                            </div>
                            <button type="submit" class="w-full py-2 bg-splunk hover:bg-splunk-dark text-white text-sm font-medium rounded-lg transition-colors">
                                Save Configuration
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Splunk Enterprise -->
                <div class="relative">
                    <button @click="splunkDropdown = !splunkDropdown; obsDropdown = false; userDropdown = false"
                            class="flex items-center gap-2 px-3 py-2 text-sm text-splunk-gray-600 hover:bg-splunk-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-database text-splunk"></i>
                        <span class="hidden md:inline">Splunk</span>
                    </button>
                    <div x-show="splunkDropdown"
                         @click.outside="splunkDropdown = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-lg border border-splunk-gray-200 overflow-hidden z-50">
                        <div class="px-4 py-3 bg-splunk-gray-50 border-b border-splunk-gray-200">
                            <h3 class="font-semibold text-splunk-gray-800">Splunk Enterprise</h3>
                            <p class="text-xs text-splunk-gray-500">HEC configuration</p>
                        </div>
                        <form method="post" action="splunk" class="p-4 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-splunk-gray-700 mb-1">HEC URL</label>
                                <input type="text" name="hec_url" placeholder="{{ g.user['hec_url'] or 'https://...' }}"
                                       class="w-full px-3 py-2 text-sm border border-splunk-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-splunk/50 focus:border-splunk">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-splunk-gray-700 mb-1">HEC Token</label>
                                <input type="password" name="hec_token"
                                       value="{{ g.user['hec_token'] or '' }}"
                                       class="w-full px-3 py-2 text-sm border border-splunk-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-splunk/50 focus:border-splunk">
                            </div>
                            <button type="submit" class="w-full py-2 bg-splunk hover:bg-splunk-dark text-white text-sm font-medium rounded-lg transition-colors">
                                Save Configuration
                            </button>
                        </form>
                    </div>
                </div>

                <div class="hidden sm:block w-px h-6 bg-splunk-gray-200 mx-2"></div>

                <!-- User menu -->
                <div class="relative">
                    <button @click="userDropdown = !userDropdown; obsDropdown = false; splunkDropdown = false"
                            class="flex items-center gap-2 px-3 py-2 text-sm text-splunk-gray-600 hover:bg-splunk-gray-100 rounded-lg transition-colors">
                        <div class="w-7 h-7 rounded-full bg-splunk flex items-center justify-center text-white text-xs font-medium">
                            {{ g.user['username'][0]|upper }}
                        </div>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div x-show="userDropdown"
                         @click.outside="userDropdown = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-splunk-gray-200 overflow-hidden z-50">
                        <div class="px-4 py-3 border-b border-splunk-gray-200">
                            <p class="text-sm font-medium text-splunk-gray-800">{{ g.user['username'] }}</p>
                            <p class="text-xs text-splunk-gray-500">Realm: {{ g.user['realm'] or 'Not set' }}</p>
                        </div>
                        <div class="py-1">
                            <a href="{{ url_for('scc.create_browser_test') }}"
                               class="flex items-center gap-3 px-4 py-2.5 text-sm text-splunk-gray-700 hover:bg-splunk-gray-50 transition-colors">
                                <i class="fas fa-rocket text-splunk-gray-400 w-4"></i>
                                Deploy Synthetics Test
                            </a>
                            <a href="{{ url_for('auth.logout') }}"
                               class="flex items-center gap-3 px-4 py-2.5 text-sm text-splunk-gray-700 hover:bg-splunk-gray-50 transition-colors">
                                <i class="fas fa-sign-out-alt text-splunk-gray-400 w-4"></i>
                                Sign out
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="flex-1 p-4 lg:p-6">
            <!-- Current status banner -->
            <div id="current-condition" class="mb-6 p-4 bg-white rounded-xl border border-splunk-gray-200 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-lg bg-splunk/10 flex items-center justify-center">
                        <i class="fas fa-broadcast-tower text-splunk"></i>
                    </div>
                    <div>
                        <p class="text-sm text-splunk-gray-500">Current Active Condition</p>
                        <p id="condition-name" class="font-semibold text-splunk-gray-800">
                            {{ condition_names.get(condition[0], condition[0]) }}
                        </p>
                    </div>
                </div>
                <a href="{{ request.url }}view/{{ g.user['username'] }}" target="_blank"
                   class="hidden sm:flex items-center gap-2 px-4 py-2 text-sm font-medium text-splunk hover:bg-splunk hover:text-white border border-splunk rounded-lg transition-colors">
                    <i class="fas fa-external-link-alt"></i>
                    View Site
                </a>
            </div>

            <!-- Cards Grid -->
            <div id="condition-cards">
                {% include 'scc/_cards.html' %}
            </div>
        </main>
    </div>
</div>
{% endblock %}
